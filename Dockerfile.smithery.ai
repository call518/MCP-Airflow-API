# This Dockerfile is exclusively for smithery.ai.

FROM rockylinux:9.3

ARG PYTHON_VERSION=3.11

# Base dependencies
RUN dnf install -y python${PYTHON_VERSION} python${PYTHON_VERSION}-pip git && dnf clean all \
        && update-alternatives --install /usr/bin/python python /usr/bin/python${PYTHON_VERSION} 1000 --slave /usr/bin/pip pip /usr/bin/pip${PYTHON_VERSION}

WORKDIR /app

COPY . /app

# Fetch git tags and update version
RUN git fetch --tags origin && \
    LATEST_TAG=$(git tag | tail -n 1) && \
    echo "LATEST_TAG='$LATEST_TAG'" && \
    sed -i "s|^version = \".*\"|version = \"${LATEST_TAG}\"|" pyproject.toml && \
    rm -rf .git

RUN pip install --no-cache-dir --upgrade wheel

RUN pip install --no-cache-dir --upgrade 'uv>=0.8.5'

RUN uv sync

RUN pip install .

# Ensure the binary is accessible and test basic functionality  
RUN which mcp-airflow-api && mcp-airflow-api --help

# Test basic functionality
RUN timeout 5s mcp-airflow-api --help || true

# Expose the HTTP port for smithery.ai  
EXPOSE 8000

# Use HTTP transport with PORT environment variable (smithery.ai requirement)
CMD ["sh", "-c", "exec mcp-airflow-api --transport http --port ${PORT:-8000} --log-level ${AIRFLOW_LOG_LEVEL:-INFO}"]